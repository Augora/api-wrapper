image: node:6.11.5
services:
  - docker:dind

stages:
  - unit
  - package

.deps_template: &deps
  before_script:
    - apt-get update
    - apt-get install -y apt-transport-https ca-certificates
    - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
    - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
    - apt-get update
    - apt-get install -y yarn
    - yarn install
    - yarn cache dir
  cache:
    paths:
      - /root/.cache/yarn/

.tests_template: &tests
  script:
    - yarn test

unit:current:
  image: node:8.8.1
  stage: unit
  <<: *deps
  <<: *tests

unit:lts:
  stage: unit
  <<: *deps
  <<: *tests

package:lib:
  stage: package
  script:
    - yarn run build
  <<: *deps
